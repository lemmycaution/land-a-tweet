window.LAT = (function () { 
  var origin = document.createElement("a")
  var frame
  var callbacks = {}

  function LAT () {
    origin.href = '<%= request.referer %>'
    origin = '<%= request.protocol + request.host + (request.port != 80 ? ":#{request.port}" : nil).to_s %>' //origin.protocol + '//' + origin.host
    frame = document.getElementById('lat-frame')
    if (!frame) {
      frame = document.body.appendChild(document.createElement('IFRAME')) 
      frame.src = '<%= public_page_url(slug: "embed-login") %>'
      frame.style.width = "100%"
      frame.style.height = "48px" 
      frame.setAttribute('scrolling', 'no')
      frame.setAttribute('frameborder', 'no')
    }
    window.addEventListener("message", this.onMessage.bind(this))
  }
  LAT.prototype.onMessage = function (event) {
    if (event.origin !== origin) return
    var action = event.data
    if (action.method === 'event') {
      frame.dispatchEvent(new Event('ready'))
    } else if (typeof callbacks[action.method] === 'function') {
      callbacks[action.method](action.data)
      delete callbacks[action.method]
    }
  }
  LAT.prototype.addEventListener = function () {
    frame.addEventListener.apply(frame, arguments)
  }
  LAT.prototype.removeEventListener = function () {
    frame.removeEventListener.apply(frame, arguments)
  }
  LAT.prototype.api = function (params) {
    callbacks[params.method] = params.callback
    delete params.callback
    frame.contentWindow.postMessage(params, origin)
  }
  
  return LAT
})()